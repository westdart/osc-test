---
# Requires vars:
#   external_registry: { host: '<the registry host>', port: '<the registry port>'}
# e.g. on command line:
#   --extra-vars '{"external_registry": { "host": "docker-registry-default.t2.training.local", port: "443"}}'

- name: Obtain Registry Certificate
  hosts: localhost

  vars_files:
    - "{{ openshift_credentials }}"

  tasks:
    - name: Include common role to get certificates
      include_role:
        name: ar_osc_common_templates
        tasks_from: get-cert
      vars:
        ar_osc_common_templates_cert_host: "{{ item.split(':')[0] }}"
        ar_osc_common_templates_cert_port: "{{ item.split(':')[1] | default('443') }}"
        ar_osc_common_templates_cert_path: "/tmp/certificate-{{ item }}.crt"
      with_items: "{{ registry_login_credentials | dict2items | map(attribute='key') | list }}"


- name: Place Registry Certificate
  hosts: "{{ target }}"
  become: true

  vars:
    docker_version_1_13: '1.13' # Earlier versions of docker require extra steps

  vars_files:
    - "{{ openshift_credentials }}"

  tasks:
    - name: Include common role to get certificates
      include_role:
        name: ar_osc_common_templates
        tasks_from: place-registry-cert
      vars:
        ar_osc_common_templates_cert_host: "{{ item.split(':')[0] }}"
        ar_osc_common_templates_cert_port: "{{ item.split(':')[1] | default('443') }}"
        ar_osc_common_templates_cert_path: "/tmp/certificate-{{ item }}.crt"
      with_items: "{{ registry_login_credentials | dict2items | map(attribute='key') | list }}"
